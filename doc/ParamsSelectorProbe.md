# Parameters, Selector parameter and Probe attribute

Handow pass parameters to steps, that's way how to reuse them. Basically, there are only 2 tpyes parameters, **Selector** and **Content**.

+ The selector is a string, **pptr** use them to try to reach element(s).
+ The content could be string (including JSON string, html snippet string, ...), number or boolean, test steps use them make decision to verify the expectations.
+ However, the content parameters can also work together with selector to help selecting elements, e.g. **xpath** selector get element by its content.

## Selector syntax

**Selectors must be consumed by pptr by relevant method**. For example, pptr can not evaluate a **CSS selector** as a **XPath selector**. The selector syntax is not an issue when users create custom steps for current project. But the type must be specified when user pass a selector parameter to built-in steps.

### Built-in steps selector types

User can see the built-in step using **CSS Slector** or **XPath** by the argument name, For example, there are 2 built-in steps for same purpose but using different pptr APIs

```js
When("I click it {selector}", async (elements) => {
    // Using CSS selector because of 'selector'
})

When("I click it {xpath}", async (elements) => {
    // Using XPath because of 'xpath'
})
```

## Using story editor

Big part!

## Global parameters

Handow stories get parameters by 2 ways:

+ Immediatly defined in current story
+ Refer global parameter table (js moodule files)

### Parameters in story

We have them in story scope and phase scope already.

### Parameters from parameter tables

We always have some parameters shared by different stories, an URL or a tab of the menu. If they are defined in one place, we can refactor them by one shot. For example, we change the URL globally to test application deployed to another environment.

A global parameter module is just a node.js module file return an object. We can put some logic in the module (e.g. computing the parameters). But mostly just a plain object, user can create it without knowing JS.

```js
/********* Global Parameters for URL**********/
'use strict';
module.exports = {
    URL_Homepage: "https://storage.googleapis.com/handow-uat-assets/static/uat-pet-store/index.html",
    URL_LoginForm: "",
    // ...
};
```

Maybe we need define multiple tables with good naming scoped.

```js
/********* Global Parameters for Message **********/
'use strict';
module.exports = {
    Message_NotFound: "https://storage.googleapis.com/handow-uat-assets/static/uat-pet-store/index.html",
    Message_NotAllowed: "",
    // ...
};
```

In story file, any step statement can refer the global parameter keys without define value. The global parameters are injected to run time by Handow like parameters defined locally.

> Parameters defined locally will override the global parameters if they have same names.

#### Specify global parameter tables in config

+ There is one config field, _config.globalParams_.
+ It is false by default, that means no global parameter table defined.
+ We can specify a path, in which all global tables are defined. e.g. _config.globalParams: '/params'_. The path is relative with app-root.
+ The _config.globalParams_ is same as other properties, it is **false** by default, but user can override it in app _config.js_ and override it again in plan config.
+ If global parameters are defained, Handow will import them into **storyRunr** before running any step. Then they are available for all steps in this story.




+ User can not implement both **CSS** and **XPath** in one test project.
+ After user change the config.selector, he must do _>handow --config_, this command will copy correct steps set to current _/steps_ directory. **!!!Important!!!**
+ Actually, Handow will perform **re-config** (_>handow --config_) automatically before run any plan.

> 

+ The most important operations of test steps are accessing element.
+ The story file define **Slector** parameters which are consumed by Puppeteer API to locate the target elements.
+ Puppeteer can consume different type selectors, e.g. CSS selector, xpath, JS-path ... User can choose any of them when they create custom steps.
+ But the built-in steps can only consume **CSS Selector**. The built-in steps always use _page.$$eval()_ to evaluate the selector and reach the elements.
+ So user must use **CSS Selector** as parameter when invoke built-in steps.

## Probe attribute

User can use any valid CSS seletor. But **IT IS NOT EASY!!!** in most situation, especailly for the SPA implement a lot of 3-party components and building tools.

+ The markups are complex if they are generated by template and building tools.
+ Developers can not control the 3-party components, e.g. bootstrap, material-UI ...
+ A lot of tags and attributes are generated after build the html, e.g. with CSS Modules ...

Anyway, most html resered in browser are not semantic and even not readable. So, how can users get the correct selector?

**Honestly**, it is very difficult and even not possible to test an existed html rendering - except they are designed friendly for test, e.g. add _"id"_ attribute to most testing targets.

> Handow do not guarantee you can test all existed application, neither do any others.

## Handow suggest using test-probe when you design the html markup

+ It is necessary to set **Test-Probe** attributes.
+ If the application existed already, you can not do this. Just too bad ...
+ Handow suggest using a custom attribute as **Test Probe**, dedicated for UAT teast.
+ We can remove these **Test Probe** from markup when we build application to production - only if they are custom dedicated attributes. (After they are removed, you can not test app anymore).
+ User can specify an attribute as probe by set it to config.
+ Handow provide easier **Probe Selector** syntax, user can use it as **CSS Selector**.
+ User can always use selectors other than probe syntax.

### Probe syntax

The probe selector syntax:

    ([scope-selector])[probe-value]([order-selector])

For example, we set _config.htmlProbe_ to be "h4w" in system config, then we can implement it to HTML like this:

```html
    <div class='foo-class'>
        <a h4w='go-to-homepage' ...></a>
        <ul>
            <li h4w='option-item'>...</li>
            <li h4w='option-item'>...</li>
            <li h4w='option-item'>...</li>
            ...
        </ul>
    </div>
```

Then the following probe selectors could be parsed into relevant CSS selector by Handow

    # Select the all matched
    'go-to-homepage@h4w'
    
    # Select the first matched
    'go-to-homepage@h4w(1)', OR 'option-item@h4w(1)'

    # Select the first matched and adding scope constraint
    '(div.foo-class)go-to-homepage@h4w(1)'

    # !! Can not use 'li' as scope contraint for 'option-item' pprobe because 'li' is not parent of the probed ele

    # with scope together with order
    '(.foo-class)option-item@h4w(3)'

Of course you can use probe with standard CSS selector syntax instead of using Handow's translating, recommand you do this.

    'option-item@h4w' --> '*[h4w=option-item]'
    '(div.foo-class)go-to-homepage@h4w' --> 'div.foo-class [h4w=go-to-homepage]'
    'option-item@h4w(1)' --> '*[h4w=option-item]:nth-child(1)'
    '(.foo-class)option-item@h4w(3)' --> '.foo-class [h4w=option-item]:nth-child(3)'

### Handow parse the probe systax to valid CSS selector

+ Try to split parameters by ().
+ If () is not at begin or end, -- not probe selector
+ If () at the begin, see relained part is "xxxx@h4w" to see if probe selector
+ If () at the end, see the ahead part is "xxxx@h4w" to see if probe selector
+ If 2 () at begin and end, see the maddle part is "xxxx@h4w" to see if probe selector
+ If no () or they are not located at begin or end, see whole string is "xxxx@h4w" to see if probe selector
+ parse probe to CSS if it is probed parameters
+ Otherwise, it is noremal CSS selector.

## XPath vs CSS

+ User can choose using any selector syntax in his custom step.
+ **Most** steps in built-in step library support 2 type selectors: CSS and Xpath.
+ Handow don't know 



## If a parameter not assigned in current feature, Handow will resolve it with global variable table.

That means it is possible **No Parameters** at all in all feature files, all the parametes come from a big variable table. e.g.

```json
    {
        "Homepage_URL": "https://....",
        "Profile_Submit_Button": "#profile-submit-button",
        "Profile_Title": "profile-title@h4w(0)",
        ...
    }
```

**We still need list the parameters for each scenario in report, even if they access global parameter table**